---
title: "Proyecto 1: el microbioma del pulque"
author: "Patricia Bustos, Montserrat García, Celso Cortés, Antonio Ovalle, Tobias Portillo, Eduardo Juscamayta, Armando Ocampo"
institute: "CDSD 2022"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: [xaringan-themer.css]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      

---
```{r xaringan-themer, include=FALSE, warning=FALSE}
library(xaringanthemer)
style_mono_accent(
  base_color = "#1c5253",
  header_font_google = google_font("Josefin Sans"),
  text_font_google   = google_font("Montserrat", "300", "300i"),
  code_font_google   = google_font("Fira Mono")
)
```

```{r xaringanExtra-clipboard, echo=FALSE}
# No quitar! Es para que aparezca la opción copy code en los R chunks
xaringanExtra::use_clipboard()
```


# Flujo de trabajo

a) MaxBin

b) MetaBat

c) DASTool

d) Extracción de Bins

e) Taxonomía

---

# MaxBin

Generación de enlaces simbólicos

```{r MAX, eval=FALSE}
 mkdir -p 01.Metabat/{data,results}
 cd 01.Metabat/
 ln -s /home/diana/samples/pulque/data/pulque.fasta data/  
 ln -s /home/diana/samples/pulque/data/pulque_sorted.bam  data/ 
```

Activación de ambiente

```{r max1, eval=FALSE}
conda activate maxbin_env
```

Cálculo de bins

```{r max2, eval=FALSE}
run_MaxBin.pl -contig data/pulque.fasta -out results/maxbin -abund data/pulque-depth.txt -max_iteration 2
```

---

# MetaBat

```{r meta, eval=FALSE}
mkdir -p 02.Metabat/{data,results}
cd 02.Metabat/
ln -s /home/diana/samples/pulque/data/pulque.fasta data/  
ln -s /home/diana/samples/pulque/data/pulque_sorted.bam  data/ 
```

Activamos el ambiente
```{r meta2, eval=FALSE}
conda activate metabat_env
```

Ensamble y archivos de profundidad

```{r meta3, eval=FALSE}
jgi_summarize_bam_contig_depths --outputDepth data/pulque-depth.txt data/pulque_sorted.bam

metabat -i data/pulque.fasta -a data/pulque-depth.txt -o results/bins -t 4 --minCVSum 0 --saveCls -d -v --minCV 0.1 -m 2000
```

---
# DASTool

Refinamiento


Preparar datos de entrada

```{r das, eval=FALSE}

Fasta_to_Scaffolds2Bin.sh -i /home/user01/01.Metabat -e fa > htn.scaffolds2bin.tsv
```


```{r das2, eval=FALSE}
PATH=/home/programs:$PATH

cd /home/programs/DAS_Tool-1.1.2

R CMD INSTALL package/DASTool_1.1.2.tar.gz

/home/programs/DAS_Tool-1.1.2/DAS_Tool -i pulque_maxbin.contigs2bin.tsv,pulque_metabat.scaffolds2bin.tsv -l maxbin,metabat -c data/pulque.fasta -o results/pulque_bins --debug -t 4  --search_engine diamond --write_bins 1 
```


---

# Extracción de Bins

```{r che, eval=FALSE}
mkdir 03.CheckM

cd 03.CheckM/

```

Activamos el ambiente

```{r che2, eval=FALSE}
conda activate checkm_env
```

```{r che3, eval=FALSE}
checkm  lineage_wf -t 4 -x fa /home/user01/04.DAS_tool/results/pulque_bins_DASTool_bins DAStools-log_htn  -f CheckM-DAS_Tool_bins.txt

sed -e '1,3d' CheckM-DAS_Tool_bins.txt | sed -e '37d' >CheckM-DAS_Tool_bins_mod.txt
```

---

# Extracción de Bins

```{r studio, eval=FALSE}
library(tidyverse)


checkm<-read.table("CheckM-DAS_Tool_bins_mod.txt", sep = "", header = F, na.strings ="", stringsAsFactors= F)


colnames(checkm)<-c("Bin_Id", "Marker", "lineage", "Number_of_genomes", 
                         "Number_of_markers", "Number_of_marker_sets", 
                         "0", "1", "2", "3", "4", "5", "Completeness", 
                         "Contamination", "Strain_heterogeneity")  

good_bins<-checkm %>%
  select(Bin_Id, Marker, Completeness, Contamination) %>%
  filter(Completeness >= 50.00) %>%
  filter(Contamination <= 10.00) 





```

---

# Extracción de Bins

```{r studio2, eval=FALSE}
medium_bins<-checkm %>%
  select(Bin_Id, Marker, Completeness, Contamination) %>%
  filter(Completeness >= 50.00) %>%
  filter(Contamination <= 20.00) 

bins<-medium_bins$Bin_Id

write.table(bins, "lista_medium_bins", quote = F, row.names = F, col.names = F)
```

---
# Bins

```{r bi, eval=FALSE}
mkdir  -p 05.Bins/{Genoma,Proteoma}

cd 05.Bins

grep ">" *.fa

change_bin_name<-function(ruta, ambiente){
ruta_original<-getwd()
setwd(ruta)
filez <- list.files()
newname<-paste0(ambiente, "_", filez)
file.rename(from=filez, to=newname)
filez <- list.files()
file.rename(from=filez, to=sub(pattern="\\.", replacement="_", filez))
setwd(ruta_original)
}
```

---

# Phylotools

```{r phy, eval=FALSE}
library(phylotools)
library(tidyverse)

change_bin_name(home/user01/05.Bins, "pulque")

add_names_to_seqs <- function(nombre_del_archivo){
  filenames <- unlist(strsplit(nombre_del_archivo, "/"))
  filenames <- filenames[[grep("fa", filenames)]]
  divide <- unlist(strsplit(filenames, "\\."))
  bin_name <- divide[1]
  termination <- divide[2]
  old_name <- get.fasta.name(nombre_del_archivo)
  new_name <- paste0( bin_name, "-scaffold-", old_name) 
  ref2 <- data.frame(old_name, new_name)
  out_file <- paste0(bin_name, "_renamed", ".", termination)
  rename.fasta(infile = nombre_del_archivo, ref_table = ref2, outfile = out_file)
}

files <- list.files(".")
files <- paste0("/home/user01/05.Bins/pulque_Genoma/", files)
map(files, add_names_to_seqs)
files
```

---
# Renombrando Bins

```{r rename, eval=FALSE}
change_bin_name<-function(ruta){
ruta_original<-getwd()
setwd(ruta)
filez <- list.files()
file.rename(from=filez, to=sub(pattern="_renamed", replacement="", filez))
setwd(ruta_original)
}

change_bin_name("/home/user01/05.Bins/Genoma/01.Bins_named")
```

---
# Taxonomía

Para la taxonomía utilizamos GTDBTK

```{r gt, eval=FALSE}
mkdir 06.GTDBTK

```

Activamos el ambiente

```{r gt2, eval=FALSE}
conda activate gtdbtk-2.1.0
```

Exportamos base de datos

```{r gt3, eval=FALSE}
export GTDBTK_DATA_PATH=/home/programs/DB/release207_v2 
```


```{r gt4, eval=FALSE}
gtdbtk classify_wf --genome_dir /home/user01/05.Bins/pulque_Genoma/Bins_named --out_dir /home/megadriveCURSO/pulqueGTDBTK --cpus 4 -x fa 
```

---

# Taxonomía

```{r tax1, eval=FALSE}
GTDBK<-read.table("/home/megadriveCURSO/pulqueGTBDBTK/classify/gtbdbtk.bac120.summary.tsv", 
  sep = "\t", header = T, 
  na.strings ="", stringsAsFactors= F)%>%
  as_tibble()

pulque_gtdbtk<-GTDBK %>%
  select(user_genome, classification) %>%
  separate(classification, c("Domain", "Phylum", "Class", "Order",
                             "Family", "Genus", "Species"), sep= ";") %>%
  rename(Bin_name=user_genome)  %>%
  unite(Bin_name_2, c("Bin_name", "Phylum"), remove = FALSE) %>%
  select(Bin_name, Domain, Phylum, Class, Order, Family, Genus, 
         Species)
```

Haciendo metadatos

```{r meta, eval=FALSE}
write.table(pulque_gtdbtk, file = "/home/megadriveCURSO/pulque/Metadatos.txt", sep="\t", quote = F,
            row.names = F, col.names = T)
```

